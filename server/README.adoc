= Kniffel Backend
:toc:
:icons: font

Express-based API for managing user accounts and Kniffel scores.
Uses Prisma and SQLite for persistence.

== ğŸš€ Getting Started

=== Prerequisites

* Frontend running at `http://localhost:5173` (or configured via `.env`)
* See xref:../README.adoc#Setup Instructions[Kniffel Web-App Setup Instructions] for complete setup and environment variable examples.

=== Database Reset

To reset the local dev DB:

[source,bash]
----
npx prisma migrate reset
----

=== Switching Database Provider

By default, SQLite is used for development.
To use PostgreSQL:

. Change the provider and url in `prisma/schema.prisma`:
+
[source,prisma]
----
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
----
. Add `DATABASE_URL` to your `.env`:
+
[source,env]
----
DATABASE_URL=postgresql://user:password@localhost:5432/kniffel
----

. Run migrations:
+
[source,bash]
----
npx prisma migrate dev
----

== ğŸ§  Tech Stack

* Express.js â€” Web framework
* Prisma ORM â€” Database client
* SQLite â€” Default development database (`dev.db`)
* express-session â€” Cookie-based session management
* bcryptjs â€” Secure password hashing
* dotenv â€” Environment variable management
* cors â€” Cross-Origin Resource Sharing middleware
* body-parser â€” Request body parsing

== ğŸ” Authentication

Session-based login using cookies (`express-session`).  
All authenticated routes require a valid session.

== ğŸ“¦ API Overview

[cols="1,1,3"]
|===
|Method |Endpoint          |Description

|POST   |/api/register     |Create a new user account
|POST   |/api/login        |Authenticate a user
|POST   |/api/logout       |Destroy session
|GET    |/api/user         |Current logged-in user info
|DELETE |/api/user         |Delete the current user
|POST   |/api/score        |Submit a new score
|GET    |/api/highscores   |Global top 10 scores
|GET    |/api/my-scores    |User's top 10 scores
|GET    |/api/my-history   |Full personal score history
|GET    |/health           |Health check
|===

== Error Handling

All error responses have the following format:

[source,json]
----
{ "error": "Error message" }
----

Possible error messages include:

* "Username already taken."
* "Invalid credentials."
* "Not logged in."
* "User not found."
* "Internal server error."
* "Invalid score value."

== ğŸ“ Backend Structure

[source,text]
----
server/
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ prisma.js                 â†’ Prisma Client instance
â”œâ”€â”€ middleware/
â”‚   â”œâ”€â”€ auth.js                   â†’ Session-based auth middleware
â”‚   â””â”€â”€ errorHandler.js           â†’ Global error handling middleware
â”œâ”€â”€ prisma/
â”‚   â”œâ”€â”€ dev.db                    â†’ SQLite development database
â”‚   â”œâ”€â”€ schema.prisma             â†’ Prisma schema definition
â”‚   â””â”€â”€ migrations/
â”‚       â”œâ”€â”€ migration_lock.toml   â†’ Prisma migration lock file
â”‚       â””â”€â”€ 20250526061148_init/
â”‚           â””â”€â”€ migration.sql     â†’ SQL definition of initial migration
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ auth.js                   â†’ Routes for registration, login, logout
â”‚   â”œâ”€â”€ score.js                  â†’ Routes for submitting and retrieving scores
â”‚   â””â”€â”€ user.js                   â†’ Routes for user info and deletion
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ asyncHandler.js           â†’ Wrapper for async route handlers
â”‚   â””â”€â”€ errorMessages.js          â†’ Centralized error messages
â”œâ”€â”€ .env                          â†’ Environment variables (not committed)
â”œâ”€â”€ index.js                      â†’ Application entry point
â””â”€â”€ README.adoc                   â†’ Backend documentation (AsciiDoc)
----