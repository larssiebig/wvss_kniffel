= Kniffel Backend
:toc:
:icons: font

This project is a Node.js backend API using Express and Prisma for managing users and their game scores.

== ğŸš€ Getting Started

=== Prerequisites

* Node.js (v18 or later)
* PostgreSQL or any Prisma-supported database
* Frontend running at `http://localhost:5173` (or configured via `.env`)

=== Installation

Install dependencies:

[source,bash]
----
npm install
node index.js
----

=== Environment Variables

Create a `.env` file in the `server/` directory with the following content:

[source,env]
----
PORT=3001
SESSION_SECRET=supersecret
FRONTEND_ORIGIN=http://localhost:5173
----

[WARNING]
====
Never commit your `.env` file to version control.  
Keep `SESSION_SECRET` long and secure (use a password generator).
====

== ğŸ§  Tech Stack

* Express.js â€” Web framework
* Prisma ORM â€” Database client
* SQLite â€” Default development database (`dev.db`)
* express-session â€” Cookie-based session management
* bcryptjs â€” Secure password hashing
* dotenv â€” Environment variable management
* cors â€” Cross-Origin Resource Sharing middleware
* body-parser â€” Request body parsing

== ğŸ” Authentication

The app uses session-based authentication.
After registering or logging in, a session is stored and managed using cookies.

== ğŸ“¦ API Endpoints

=== `POST /api/register`

Registers a new user and starts a session.

[source,json]
----
{ "username": "name", "password": "pass" }
----

=== `POST /api/login`

Logs in a user and starts a session.

[source,json]
----
{ "username": "name", "password": "pass" }
----

=== `POST /api/logout`

Destroys the current user session.

=== `GET /api/user`

Returns information about the currently authenticated user.

=== `DELETE /api/user`

Deletes the currently authenticated user and all their scores.

NOTE: This endpoint is now protected and only deletes the logged-in user.

=== `POST /api/score`

Submits a new score (requires authentication).

[source,json]
----
{ "value": 100 }
----

=== `GET /api/highscores`

Returns the top 10 scores globally.

=== `GET /api/my-scores`

Returns the top 10 scores of the authenticated user.

=== `GET /api/my-history`

Returns the full score history of the authenticated user.

=== `GET /health`

Simple health check.

[source,json]
----
{ "status": "ok" }
----

== Error Handling

All error responses have the following format:

[source,json]
----
{ "error": "Error message" }
----

Possible error messages include:

* "Username already taken."
* "Invalid credentials."
* "Not logged in."
* "User not found."
* "Internal server error."
* "Invalid score value."

== ğŸ“ Backend Structure

[source,text]
----
server/
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ prisma.js                 â†’ Prisma Client instance
â”œâ”€â”€ middleware/
â”‚   â”œâ”€â”€ auth.js                   â†’ Session-based auth middleware
â”‚   â””â”€â”€ errorHandler.js           â†’ Global error handling middleware
â”œâ”€â”€ prisma/
â”‚   â”œâ”€â”€ dev.db                    â†’ SQLite development database
â”‚   â”œâ”€â”€ schema.prisma             â†’ Prisma schema definition
â”‚   â””â”€â”€ migrations/
â”‚       â”œâ”€â”€ migration_lock.toml   â†’ Prisma migration lock file
â”‚       â””â”€â”€ 20250526061148_init/
â”‚           â””â”€â”€ migration.sql     â†’ SQL definition of initial migration
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ auth.js                   â†’ Routes for registration, login, logout
â”‚   â”œâ”€â”€ score.js                  â†’ Routes for submitting and retrieving scores
â”‚   â””â”€â”€ user.js                   â†’ Routes for user info and deletion
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ asyncHandler.js           â†’ Wrapper for async route handlers
â”œâ”€â”€ .env                          â†’ Environment variables (not committed)
â”œâ”€â”€ index.js                      â†’ Application entry point
â””â”€â”€ README.adoc                   â†’ Backend documentation (AsciiDoc)
----